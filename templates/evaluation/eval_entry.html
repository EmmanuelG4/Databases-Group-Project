{% extends "layout.html" %}

{% block title %}Enter or Check Evaluations{% endblock %}

{% block content %}
<div class="container-full">
    <h2>Evaluations for {{ context.sec_term }} {{ context.sec_year }}</h2>
    <h3>{{ context.degree_name }} ({{ context.degree_level }}) – Instructor: {{ context.instructor_id }}</h3>
    
    <hr>
    
    <form method="POST" action="{{ url_for('evaluation.save_evaluation') }}">
        
        <input type="hidden" name="degree_name" value="{{ context.degree_name }}">
        <input type="hidden" name="degree_level" value="{{ context.degree_level }}">
        <input type="hidden" name="sec_term" value="{{ context.sec_term }}">
        <input type="hidden" name="sec_year" value="{{ context.sec_year }}">
        
        {% if sections_data %}
            
            {% for section_item in sections_data %}
                {% set section = section_item.section %}
                {% set objectives = section_item.objectives %}

                <div class="section-block {{ section_item.status | lower | replace(' ', '-') }}">
                    
                    <div class="section-header">
                        <h4>
                            {{ section.course_num }}-{{ section.sec_num }} - {{ section.course_name }} 
                            <span class="status-tag">Status: {{ section_item.status }}</span>
                        </h4>
                        <p>Students in class: {{ section.num_students }}</p>
                    </div>

                    {% if objectives %}
                        <div class="objectives-list">
                            {% for obj in objectives %}

                            <div class="objective-entry {{ obj.status | lower }}">
                                <h5>
                                    &#10003; {{ obj.obj_code }} - {{ obj.title }}
                                </h5>
                                
                                {% if obj.status == 'Missing' %}
                                    <p class="missing-warning">You still need to enter evaluation info for this objective.</p>
                                {% endif %}

                                {% set prefix = section.course_num ~ '|' ~ section.sec_num ~ '|' ~ obj.obj_code ~ '|' %}

                                <div class="form-row">
                                    <div class="form-group-half">
                                        <label for="{{ prefix }}based_on">What is this based on?</label>
                                        <input type="text" 
                                            name="{{ prefix }}based_on" 
                                            id="{{ prefix }}based_on" 
                                            placeholder="Example: Final project, exam, or lab"
                                            value="{{ obj.based_on if obj.based_on is defined else '' }}"
                                            required>
                                    </div>
                                    <div class="form-group-half checkbox-group">
                                        <input type="checkbox" 
                                            name="{{ prefix }}duplicate" 
                                            id="{{ prefix }}duplicate">
                                        <label for="{{ prefix }}duplicate">Use these results for other degrees too?</label>
                                        <small>This will copy the same results to other degrees that use this course/objective.</small>
                                    </div>
                                </div>
                                
                                <div class="form-row grades">
                                    <label>How many students hit each level? (Max: {{ section.num_students }})</label>
                                    
                                    <div class="grade-input">
                                        <label for="{{ prefix }}perform_a">A:</label>
                                        <input type="number"
                                            name="{{ prefix }}perform_a"
                                            value="{{ obj.perform_a if obj.perform_a is defined else 0 }}"
                                            min="0">
                                    </div>
                                    
                                    <div class="grade-input">
                                        <label for="{{ prefix }}perform_b">B:</label>
                                        <input type="number"
                                            name="{{ prefix }}perform_b"
                                            value="{{ obj.perform_b if obj.perform_b is defined else 0 }}"
                                            min="0">
                                    </div>
                                    
                                    <div class="grade-input">
                                        <label for="{{ prefix }}perform_c">C:</label>
                                        <input type="number"
                                            name="{{ prefix }}perform_c"
                                            value="{{ obj.perform_c if obj.perform_c is defined else 0 }}"
                                            min="0">
                                    </div>
                                    
                                    <div class="grade-input">
                                        <label for="{{ prefix }}perform_f">F:</label>
                                        <input type="number"
                                            name="{{ prefix }}perform_f"
                                            value="{{ obj.perform_f if obj.perform_f is defined else 0 }}"
                                            min="0">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{ prefix }}improvements">Any ideas to improve this course? (Optional)</label>
                                    <textarea name="{{ prefix }}improvements"
                                            id="{{ prefix }}improvements"
                                            rows="2"
                                            placeholder="Write any suggestions you have based on how students did.">{{ obj.improvements if obj.improvements is defined else '' }}</textarea>
                                </div>
                            </div>

                        {% endfor %}

                        </div>
                    {% else %}
                        <p class="warning">There aren’t any objectives linked to this course for {{ context.degree_name }} ({{ context.degree_level }}).</p>
                    {% endif %}
                </div>
            {% endfor %}
            
            <button type="submit" class="btn btn-primary btn-save-all">Save All Evaluations</button>

        {% else %}
            <p class="warning">There are no sections for this instructor in {{ context.sec_term }} {{ context.sec_year }} that need evaluation for this degree.</p>
            <a href="{{ url_for('evaluation.select_evaluation') }}" class="btn btn-secondary">Back to Degree/Term Selection</a>
        {% endif %}

    </form>
</div>

<style>
    /* Main container */
    .container-full {
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Each section/course block */
    .section-block {
        margin-bottom: 40px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .section-header {
        border-bottom: 2px solid #5cb85c;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .section-block h4 {
        margin-top: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Status tags */
    .status-tag {
        font-size: 0.9em;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }
    .fully-entered .status-tag { background-color: #d4edda; color: #155724; }
    .partially-entered .status-tag { background-color: #fff3cd; color: #856404; }
    .not-entered .status-tag { background-color: #f8d7da; color: #721c24; }

    /* Objectives */
    .objective-entry {
        border: 1px solid #eee;
        padding: 15px;
        margin-top: 10px;
        border-radius: 4px;
        background-color: #fff;
    }
    .objective-entry h5 {
        color: #007bff;
        margin-top: 0;
    }
    .missing-warning {
        color: #dc3545;
        font-weight: bold;
    }

    /* Form layout */
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
        align-items: flex-end;
    }

    .form-group-half { 
        flex: 1; 
    }

    /* Grade inputs */
    .grades {
        justify-content: space-around;
        align-items: center;
        border: 1px dashed #ccc;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }

    .grade-input {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .grade-input input {
        width: 60px;
        text-align: center;
    }

    .btn-save-all {
        width: 100%;
        margin-top: 20px;
        padding: 15px;
        font-size: 1.2em;
        background-color: #28a745;
    }
</style>
{% endblock %}
